<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <link rel="stylesheet" type="text/css" href="{{ static('css/portal/index.css') }}" />
    <link rel="icon" href="{{ static('/images/_voxelfox/logo.png') }}" />
    <title>Voxel Fox Payment Portal</title>
</head>
<body>

<div class="container">
    <div id="guild-items" class="block">
        {% if guild_items %}
            <h1 class="title">Per-Guild Items</h1>
            <div class="items">
                {% for item in guild_items %}
                    <div class="item" data-id="{{ item.id }}">
                        <p class="name">{{ item.name }}</p>
                        {% if item.description %}
                            <p class="description">{{ item.description }}</p>
                        {% endif %}
                        <p class="price">Price: <span>{{ item.currency_symbol }}{{ item.price }}</span></p>
                        <select class="select guild-select" onchange="javascript:guildSelectChange('{{ item.id }}')">
                            <option value="">Purchase for Guild</option>
                        </select>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
    <div id="user-items" class="block">
        {% if user_items %}
            <h1 class="title">Per-User Items</h1>
            <div class="items">
                {% for item in user_items %}
                    <div class="item" data-id="{{ item.id }}">
                        <p class="name">{{ item.name }}</p>
                        {% if item.description %}
                            <p class="description">{{ item.description }}</p>
                        {% endif %}
                        <p class="price">Price: <span>{{ item.currency_symbol }}{{ item.price }}</span></p>
                        <a href="/portal/item/{{ item.id }}" class="button">Purchase</a>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

<script type="text/javascript">
function guildSelectChange(itemId) {
    var guildSelect = document.querySelector(`.item[data-id="${itemId}"] .guild-select`);
    var guildId = guildSelect.value;
    if (!guildId) {
        return;
    }
    window.location.href = `/portal/item/${itemId}?guild=${guildId}`;
}


async function getGuilds() {
    var guilds = await fetch("/api/portal/get_guilds");
    guilds = await guilds.json();
    guilds.sort((a, b) => {
        var nameA = a.name.toUpperCase();
        var nameB = b.name.toUpperCase();
        if (nameA < nameB) {
            return -1;
        }
        if (nameA > nameB) {
            return 1;
        }
        return parseInt(a.id) - parseInt(b.id);
    });
    for(let select of document.querySelectorAll(".guild-select")) {
        select.innerHTML = "<option value='' selected>Purchase for Guild</option>";
        let group = document.createElement("optgroup");
        group.label = "Guilds";
        for(let guild of guilds) {
            let option = document.createElement("option");
            option.value = guild.id;
            option.innerText = guild.name;
            group.appendChild(option);
        }
        select.appendChild(group);
    }
}
getGuilds();
</script>

</body>
</html>
